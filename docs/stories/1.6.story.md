# Story 1.6: Setup Monitoring and Error Tracking

## Status

**Draft**

---

## Story

**As a** developer,
**I want** Sentry error tracking and PostHog analytics integrated,
**so that** I can monitor application health and user behavior in production.

---

## Acceptance Criteria

1. Sentry installed and configured with Next.js integration
2. Test error captured and visible in Sentry dashboard
3. PostHog initialized with basic page view tracking
4. Environment-specific configuration (disable in development, enable in production)
5. User identification integrated with auth system (privacy-safe)
6. Source maps configured for readable error stack traces

---

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Sentry SDK for Next.js 15** (AC: 1, 6)
  - [ ] Install Sentry Next.js package: `npm install @sentry/nextjs`
  - [ ] Run Sentry wizard: `npx @sentry/wizard@latest -i nextjs` to auto-configure
  - [ ] Verify Sentry creates config files: `sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`
  - [ ] Add `SENTRY_DSN` to `.env.local` (from Sentry dashboard)
  - [ ] Configure Sentry options:
    - [ ] Set `environment` based on `VERCEL_ENV` or `NODE_ENV`
    - [ ] Enable source maps for production builds
    - [ ] Set `tracesSampleRate` to 0.1 (10% performance monitoring)
    - [ ] Configure release versioning using git commit SHA
  - [ ] Update `next.config.js` with Sentry webpack plugin settings
  - [ ] Test Sentry locally by triggering a test error
  - [ ] Verify source maps upload to Sentry for readable stack traces

- [ ] **Task 2: Integrate User Context with NextAuth Session** (AC: 5)
  - [ ] Create Sentry helper function in `lib/monitoring/sentry-helpers.ts`
  - [ ] Implement `setUserContext(user)` function that calls `Sentry.setUser()`
  - [ ] Extract privacy-safe user fields: `id`, `email` (hashed for privacy), `tier`
  - [ ] Add user context in auth callback (`lib/auth/config.ts`) after successful login
  - [ ] Add user context in dashboard layout (`app/(authenticated)/layout.tsx`) on mount
  - [ ] Test user context appears in Sentry error reports
  - [ ] Ensure no sensitive data (passwords, tokens) is sent to Sentry

- [ ] **Task 3: Create Test Error Route for Sentry Verification** (AC: 2)
  - [ ] Create debug route: `app/api/debug/sentry-test/route.ts`
  - [ ] Implement GET handler that throws intentional error
  - [ ] Add environment check: only accessible in development or via secret query param
  - [ ] Test route locally: `curl http://localhost:3000/api/debug/sentry-test`
  - [ ] Verify error appears in Sentry dashboard with correct stack trace
  - [ ] Verify source maps make stack trace readable (shows actual file/line)
  - [ ] Add client-side error test button on `/dashboard` (dev mode only)

- [ ] **Task 4: Install and Configure PostHog SDK** (AC: 3)
  - [ ] Install PostHog: `npm install posthog-js`
  - [ ] Create PostHog provider component: `components/analytics/posthog-provider.tsx`
  - [ ] Initialize PostHog with `NEXT_PUBLIC_POSTHOG_KEY` and host URL
  - [ ] Configure options:
    - [ ] Disable in development: `enabled: process.env.NODE_ENV === 'production'`
    - [ ] Enable auto-capture for page views
    - [ ] Disable session recording for MVP (can enable later)
  - [ ] Wrap app with PostHog provider in `app/layout.tsx`
  - [ ] Test page view tracking locally (check PostHog dashboard)

- [ ] **Task 5: Integrate User Identification with PostHog** (AC: 5)
  - [ ] Create PostHog helper in `lib/monitoring/posthog-helpers.ts`
  - [ ] Implement `identifyUser(user)` function using `posthog.identify()`
  - [ ] Set user properties: `userId`, `email`, `tier`, `createdAt`
  - [ ] Call `identifyUser()` in auth callback after login
  - [ ] Call `identifyUser()` in dashboard layout on mount (client-side)
  - [ ] Implement logout tracking: call `posthog.reset()` on logout
  - [ ] Test user identification appears in PostHog dashboard

- [ ] **Task 6: Configure Environment-Specific Behavior** (AC: 4)
  - [ ] Update `.env.example` with monitoring variables:
    - [ ] `SENTRY_DSN=https://...@sentry.io/...`
    - [ ] `NEXT_PUBLIC_POSTHOG_KEY=phc_...`
    - [ ] `NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com` (or self-hosted URL)
  - [ ] Create environment config helper: `lib/config/monitoring.ts`
  - [ ] Export `isMonitoringEnabled` function (checks production env)
  - [ ] Ensure Sentry/PostHog are disabled in development mode
  - [ ] Verify monitoring only runs in production/preview Vercel environments
  - [ ] Test locally that no telemetry is sent in dev mode

- [ ] **Task 7: Deploy to Vercel and Verify Monitoring** (AC: All)
  - [ ] Add environment variables to Vercel project:
    - [ ] `SENTRY_DSN` (production value)
    - [ ] `NEXT_PUBLIC_POSTHOG_KEY` (production value)
    - [ ] `NEXT_PUBLIC_POSTHOG_HOST` (production value)
    - [ ] `SENTRY_AUTH_TOKEN` (for source map uploads - optional)
  - [ ] Commit and push to trigger deployment
  - [ ] Monitor build logs for Sentry source map upload
  - [ ] Visit production URL and navigate through pages
  - [ ] Trigger test error in production (via debug route with secret)
  - [ ] Verify error appears in Sentry with source maps
  - [ ] Verify page views appear in PostHog dashboard
  - [ ] Verify user context attached to Sentry errors
  - [ ] Verify user identification works in PostHog

- [ ] **Task 8: Write Tests for Monitoring Helpers** (Testing)
  - [ ] Create test file: `__tests__/lib/monitoring/sentry-helpers.test.ts`
  - [ ] Mock Sentry SDK methods (`setUser`, `captureException`)
  - [ ] Test `setUserContext()` calls Sentry.setUser with correct fields
  - [ ] Test user context excludes sensitive fields
  - [ ] Create test file: `__tests__/lib/monitoring/posthog-helpers.test.ts`
  - [ ] Mock PostHog SDK methods (`identify`, `reset`)
  - [ ] Test `identifyUser()` calls posthog.identify with correct properties
  - [ ] Test logout calls posthog.reset()
  - [ ] Run tests with `npm test`

- [ ] **Task 9: Update Documentation** (AC: All)
  - [ ] Update README with monitoring section:
    - [ ] Sentry setup instructions (create account, get DSN)
    - [ ] PostHog setup instructions (create project, get API key)
    - [ ] Environment variable configuration
    - [ ] How to test error tracking locally
  - [ ] Document monitoring best practices:
    - [ ] When to use `Sentry.captureException()` vs `Sentry.captureMessage()`
    - [ ] How to add custom tags/context to errors
    - [ ] How to track custom events in PostHog
  - [ ] Add troubleshooting section for common monitoring issues

---

## Dev Notes

### Previous Story Insights

From Story 1.5 (Vercel Deployment):
- Production deployment fully functional on Vercel
- Environment variables configured: `DATABASE_URL`, `AUTH_SECRET`, `AUTH_URL`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
- Health check endpoint (`/api/health`) working and verified
- NextAuth v5 session management with Google OAuth in production
- Automatic deployments trigger on push to `main` branch
- Vercel project and GitHub integration configured

From Story 1.3 (Authentication):
- NextAuth v5 configured with Google OAuth provider
- User session includes: `id`, `email`, `name`, `image`, `credits`, `tier`
- Auth configuration in `lib/auth/config.ts` and `lib/auth/index.ts`
- User context available server-side via `getServerSession()`
- User context available client-side via `useSession()` hook from `hooks/use-session.ts`

From Story 1.4 (Dashboard):
- Dashboard route (`/dashboard`) fully functional
- User profile displayed with name, email, avatar
- Logout functionality implemented in `components/auth/logout-button.tsx`
- Client-side session provider in `app/providers.tsx`

### Monitoring Architecture
[Source: architecture/monitoring-and-observability.md]

**Monitoring Stack:**
- **Frontend Monitoring:** Sentry (errors), PostHog (analytics)
- **Backend Monitoring:** Sentry (errors), Vercel Logs
- **Performance:** PostHog (Core Web Vitals)

**Key Metrics:**

Frontend:
- Core Web Vitals (LCP, FID, CLS)
- JavaScript errors
- API response times

Backend:
- Request rate
- Error rate
- Response time (p50, p95, p99)
- Database query performance

### Tech Stack - Monitoring
[Source: architecture/tech-stack.md]

**Monitoring:** Sentry (Latest)
- **Purpose:** Error tracking + performance
- **Features:** Source maps for readable traces, user context from NextAuth
- **PRD Requirement:** NFR9

**Analytics:** PostHog (Latest)
- **Purpose:** Product analytics + feature flags
- **Features:** Self-serve analytics, session recordings, A/B testing
- **PRD Requirement:** NFR9

**Logging:** Vercel Logs
- **Purpose:** Serverless function logs
- **Features:** Built-in real-time logs, structured JSON, retention for debugging
- **Note:** Already available from Story 1.5, no additional setup needed

### Sentry Configuration for Next.js 15
[Source: architecture/tech-stack.md, architecture/monitoring-and-observability.md]

**Installation:**
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

**Sentry Wizard Auto-Creates:**
- `sentry.client.config.ts` - Client-side Sentry initialization
- `sentry.server.config.ts` - Server-side Sentry initialization (API routes, Server Actions)
- `sentry.edge.config.ts` - Edge runtime Sentry (middleware)
- Updates `next.config.js` with Sentry webpack plugin

**Configuration Options:**
```typescript
// sentry.client.config.ts and sentry.server.config.ts
Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.VERCEL_ENV || process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10% performance monitoring
  release: process.env.VERCEL_GIT_COMMIT_SHA, // Git commit for releases
  // Enable source maps for production
  integrations: [
    new Sentry.BrowserTracing(), // Client-side only
  ],
});
```

**Environment Variables:**
- `SENTRY_DSN` - Sentry Data Source Name (from Sentry dashboard)
- `SENTRY_AUTH_TOKEN` - For uploading source maps (optional, wizard provides)

**Source Maps:**
- Automatically uploaded during `npm run build` via Sentry webpack plugin
- Configured in `next.config.js` by wizard
- Makes production stack traces readable (shows actual file names/lines)

### PostHog Configuration
[Source: architecture/tech-stack.md]

**Installation:**
```bash
npm install posthog-js
```

**PostHog Provider Pattern:**
```typescript
// components/analytics/posthog-provider.tsx
'use client';
import posthog from 'posthog-js';
import { PostHogProvider } from 'posthog-js/react';
import { useEffect } from 'react';

export function PHProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    if (typeof window !== 'undefined') {
      posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
        api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://app.posthog.com',
        loaded: (posthog) => {
          if (process.env.NODE_ENV === 'development') posthog.opt_out_capturing();
        },
      });
    }
  }, []);

  return <PostHogProvider client={posthog}>{children}</PostHogProvider>;
}
```

**Integration with Next.js App Router:**
- Wrap `app/layout.tsx` with `<PHProvider>`
- Auto-captures page views using Next.js router events
- Disable in development with `posthog.opt_out_capturing()`

**Environment Variables:**
- `NEXT_PUBLIC_POSTHOG_KEY` - PostHog API key (public, safe for client-side)
- `NEXT_PUBLIC_POSTHOG_HOST` - PostHog host URL (default: https://app.posthog.com)

### User Context Integration
[Source: architecture/monitoring-and-observability.md]

**Sentry User Context:**
- Attach user info to error reports for debugging
- Privacy-safe fields: `id`, `email` (hashed or truncated), `tier`
- Set via `Sentry.setUser({ id, email, tier })` after login

**PostHog User Identification:**
- Track user behavior across sessions
- Use `posthog.identify(userId, { email, tier, createdAt })`
- Call `posthog.reset()` on logout to clear user identity

**Where to Add User Context:**
1. Auth callback (`lib/auth/config.ts`) - Server-side after login
2. Dashboard layout (`app/(authenticated)/layout.tsx`) - Client-side on mount
3. Logout handler - Clear user context on logout

**IMPORTANT:** Never send sensitive data (passwords, API keys, tokens) to monitoring services.

### Environment-Specific Configuration
[Source: architecture/development-workflow.md#environment-variables]

**Development vs Production:**
- **Development:** Disable Sentry/PostHog to avoid noise
- **Production:** Enable full monitoring
- **Preview (Vercel):** Enable monitoring for testing

**Environment Detection:**
```typescript
// lib/config/monitoring.ts
export const isMonitoringEnabled = () => {
  return process.env.NODE_ENV === 'production' || process.env.VERCEL_ENV === 'preview';
};
```

**Vercel Environment Variables:**
- `VERCEL_ENV` - Environment name: `production`, `preview`, or `development`
- `NODE_ENV` - Node environment: `production` or `development`
- `VERCEL_GIT_COMMIT_SHA` - Git commit SHA for release tracking

### Error Handling Integration
[Source: architecture/error-handling-strategy.md]

**Standard Error Classes:**
- `NotFoundError` - Resource doesn't exist
- `InsufficientCreditsError` - Not enough credits
- `UnauthorizedError` - Not authenticated
- `ValidationError` - Invalid input (Zod)

**Sentry Capture Strategy:**
- **Automatic:** All unhandled errors and exceptions
- **Manual:** Use `Sentry.captureException(error)` in catch blocks
- **Messages:** Use `Sentry.captureMessage()` for non-error warnings
- **Tags:** Add custom tags for filtering: `Sentry.setTag('feature', 'cv-editor')`

### File Locations
[Source: architecture/unified-project-structure.md]

**Files to Create:**
- `sentry.client.config.ts` - Sentry client-side config (auto-created by wizard)
- `sentry.server.config.ts` - Sentry server-side config (auto-created by wizard)
- `sentry.edge.config.ts` - Sentry edge runtime config (auto-created by wizard)
- `components/analytics/posthog-provider.tsx` - PostHog provider component
- `lib/monitoring/sentry-helpers.ts` - Sentry user context helpers
- `lib/monitoring/posthog-helpers.ts` - PostHog user identification helpers
- `lib/config/monitoring.ts` - Environment config for monitoring
- `app/api/debug/sentry-test/route.ts` - Test error route (optional)
- `__tests__/lib/monitoring/sentry-helpers.test.ts` - Sentry tests
- `__tests__/lib/monitoring/posthog-helpers.test.ts` - PostHog tests

**Files to Modify:**
- `app/layout.tsx` - Wrap with PostHog provider
- `app/(authenticated)/layout.tsx` - Add user identification on mount
- `lib/auth/config.ts` - Add user context in auth callback
- `components/auth/logout-button.tsx` - Clear user context on logout
- `next.config.js` - Sentry webpack plugin config (auto-updated by wizard)
- `.env.example` - Add monitoring environment variables
- `README.md` - Add monitoring setup documentation

**Existing Files to Reference:**
- `lib/auth/config.ts` - NextAuth callbacks for user context
- `hooks/use-session.ts` - Client-side session hook
- `app/providers.tsx` - Existing SessionProvider wrapper

### Coding Standards
[Source: architecture/coding-standards.md]

**Environment Variables:**
- Access via config objects, never `process.env` directly
- Public variables must use `NEXT_PUBLIC_` prefix
- Private variables (server-only) have no prefix

**Error Handling:**
- Use standard error classes from `server/utils/errors.ts`
- Always wrap monitoring calls in try-catch to prevent monitoring failures from breaking app

**Type Safety:**
- TypeScript strict mode enabled
- No `any` types in monitoring helpers
- Use proper type guards for environment variables

### Testing Strategy
[Source: architecture/testing-strategy.md]

**Test Organization:**
- Monitoring tests: `__tests__/lib/monitoring/`
- Unit tests for helper functions (70% coverage target)
- No E2E tests needed for monitoring setup

**Mocking Strategy:**
- Mock Sentry SDK: `vi.mock('@sentry/nextjs')`
- Mock PostHog SDK: `vi.mock('posthog-js')`
- Verify function calls without actually sending telemetry

**Test Requirements:**
- Test user context helpers call Sentry/PostHog correctly
- Test environment detection logic
- Test privacy-safe field extraction
- Ensure no sensitive data in monitoring payloads

### Project Structure Alignment
[Source: architecture/unified-project-structure.md]

**Monitoring Structure:**
```
lib/
├── monitoring/
│   ├── sentry-helpers.ts    # NEW
│   └── posthog-helpers.ts   # NEW
├── config/
│   └── monitoring.ts        # NEW
components/
└── analytics/
    └── posthog-provider.tsx # NEW
app/
└── api/
    └── debug/
        └── sentry-test/
            └── route.ts     # NEW (optional)
sentry.client.config.ts      # NEW (auto-created)
sentry.server.config.ts      # NEW (auto-created)
sentry.edge.config.ts        # NEW (auto-created)
```

**No Conflicts Found** - All file locations align with defined structure.

---

## Dev Notes - Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test Organization:**
- Monitoring tests: `__tests__/lib/monitoring/`
- Use Vitest for unit tests
- Mock external SDKs to prevent actual telemetry in tests

**Testing Approach:**
- Unit tests for helper functions
- Mock Sentry and PostHog SDKs
- Verify correct function calls with expected parameters
- Test environment-specific behavior (dev vs production)
- Test privacy-safe data extraction

**Test File Locations:**
- `__tests__/lib/monitoring/sentry-helpers.test.ts`
- `__tests__/lib/monitoring/posthog-helpers.test.ts`

**Mocking Examples:**
```typescript
// Sentry mocking
vi.mock('@sentry/nextjs', () => ({
  setUser: vi.fn(),
  captureException: vi.fn(),
}));

// PostHog mocking
vi.mock('posthog-js', () => ({
  default: {
    identify: vi.fn(),
    reset: vi.fn(),
    opt_out_capturing: vi.fn(),
  },
}));
```

**Test Coverage Requirements:**
- User context helpers: 100% (critical for privacy)
- Environment detection: 100% (critical for correct behavior)
- Integration helpers: 80%+ (focus on happy path + error handling)

### Monitoring Verification Checklist

**Pre-Deployment:**
- [ ] Sentry DSN configured in `.env.local`
- [ ] PostHog API key configured in `.env.local`
- [ ] Test error appears in Sentry dashboard
- [ ] Page views appear in PostHog dashboard
- [ ] No monitoring telemetry in development mode
- [ ] All tests pass locally (`npm test`)
- [ ] Linting passes (`npm run lint`)

**Post-Deployment:**
- [ ] Environment variables added to Vercel
- [ ] Source maps uploaded to Sentry (check build logs)
- [ ] Trigger test error in production
- [ ] Error appears in Sentry with source maps
- [ ] User context attached to Sentry errors
- [ ] Page views appear in PostHog
- [ ] User identification works in PostHog
- [ ] No sensitive data in monitoring payloads

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
